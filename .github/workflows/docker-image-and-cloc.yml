name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile-build-and-run --tag my-image-name:$(date +%s)

    - name: Install cloc
      run: sudo apt-get update && sudo apt-get install -y cloc

    - name: Calculate LOC metric
      id: cloc
      run: |
        METRIC=$(cd minified ; cloc . | tac | sed -n 2p | awk '{ print $NF }')
        echo "LOC_METRIC=$METRIC" >> $GITHUB_ENV

    - name: Report metric to Job Summary
      run: |
        echo "## ðŸ“Š Raport Metryki Kodu (LOC)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Nasza niestandardowa metryka (im mniej, tym lepiej):" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# **${{ env.LOC_METRIC }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "![Metric Badge](https://img.shields.io/badge/LinesOfCode-${{ env.LOC_METRIC }}-blue)" >> $GITHUB_STEP_SUMMARY
