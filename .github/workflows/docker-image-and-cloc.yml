name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile-build-and-run --tag my-image-name:$(date +%s)

    - name: Install cloc
      run: sudo apt-get update && sudo apt-get install -y cloc

    - name: Calculate LOC Metric
      id: loc_metric
      run: |
        LOC_VALUE=$(cd minified ; cloc . | tac | sed -n 2p | awk '{ print $NF }' | numfmt --grouping)
        echo "metric_value=$LOC_VALUE" >> $GITHUB_OUTPUT

    - name: Report Metric to Job Summary
      run: |
        echo "## ðŸ“‰ Metryka Linii Kodu (LOC)" >> $GITHUB_STEP_SUMMARY
        echo "Im mniej, tym lepiej." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metryka | WartoÅ›Ä‡ |" >> $GITHUB_STEP_SUMMARY
        echo "|---|---|" >> $GITHUB_STEP_SUMMARY
        echo "| **Liczba Linii Kodu (LOC)** | \`${{ steps.loc_metric.outputs.metric_value }}\` |" >> $GITHUB_STEP_SUMMARY

    - name: Post Metric as PR Comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: loc-metric-summary
        message: |
          ## ðŸ“‰ Metryka PostÄ™pu (Lines of Code)
          
          | Metryka | WartoÅ›Ä‡ |
          |---|---|
          | **Liczba Linii Kodu (LOC)** | `${{ steps.loc_metric.outputs.metric_value }}` |
          
          *(Im mniej, tym lepiej)*

##############################################################################


    - name: Measure LOC
      id: measure
      run: |
        # Count current LOC
        LOC=$(cd minified && cloc . --quiet | tac | sed -n 2p | awk '{ print $NF }')
        echo "loc=$LOC" >> $GITHUB_OUTPUT
        echo "Lines of Code: $LOC"
        
        # Determine status
        if [ $LOC -lt 320000 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "description=âœ… LOC: $LOC (Goal achieved!)" >> $GITHUB_OUTPUT
        elif [ $LOC -lt 350000 ]; then
          echo "status=pending" >> $GITHUB_OUTPUT  
          echo "description=âš ï¸ LOC: $LOC (Above goal by $((LOC-320000)))" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "description=âŒ LOC: $LOC (Critical - reduce by $((LOC-320000)))" >> $GITHUB_OUTPUT
        fi
        
        # If PR, calculate diff
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          git checkout origin/${{ github.base_ref }} 2>/dev/null || true
          if [ -d minified ]; then
            BASE_LOC=$(cd minified && cloc . --quiet | tac | sed -n 2p | awk '{ print $NF }' 2>/dev/null || echo 0)
            DIFF=$((LOC - BASE_LOC))
            echo "base_loc=$BASE_LOC" >> $GITHUB_OUTPUT
            echo "diff=$DIFF" >> $GITHUB_OUTPUT
            
            if [ $DIFF -gt 0 ]; then
              echo "trend=+$DIFF lines ðŸ“ˆ" >> $GITHUB_OUTPUT
            elif [ $DIFF -lt 0 ]; then
              echo "trend=$DIFF lines ðŸ“‰" >> $GITHUB_OUTPUT
            else
              echo "trend=No change âž¡ï¸" >> $GITHUB_OUTPUT
            fi
          fi
          git checkout - 2>/dev/null || true
        fi
    
    - name: Create Status
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        curl -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
          -d '{
            "state": "${{ steps.measure.outputs.status }}",
            "description": "${{ steps.measure.outputs.description }}",
            "context": "LOC Metrics",
            "target_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'
    
    - name: Add Job Summary
      if: always()
      run: |
        echo "# ðŸ“Š Lines of Code Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Current: **${{ steps.measure.outputs.loc }}** lines" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "${{ steps.measure.outputs.diff }}" ]; then
          echo "### Pull Request Changes" >> $GITHUB_STEP_SUMMARY
          echo "- Base branch: ${{ steps.measure.outputs.base_loc }} lines" >> $GITHUB_STEP_SUMMARY
          echo "- This PR: ${{ steps.measure.outputs.loc }} lines" >> $GITHUB_STEP_SUMMARY
          echo "- **Change: ${{ steps.measure.outputs.trend }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### Goals" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Target: < 320,000 lines" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ steps.measure.outputs.description }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "<details><summary>Full cloc report</summary>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cd minified && cloc . >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "</details>" >> $GITHUB_STEP_SUMMARY
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const loc = '${{ steps.measure.outputs.loc }}';
          const status = '${{ steps.measure.outputs.status }}';
          const trend = '${{ steps.measure.outputs.trend }}' || '';
          
          const body = `## ðŸ“Š LOC Metrics\n\n**Current:** ${loc} lines ${trend}\n\n${
            status === 'success' ? 'âœ… Within target!' : 
            status === 'pending' ? 'âš ï¸ Above target (320k)' : 
            'âŒ Critical - please reduce code size'
          }`;
          
          // Find and update existing comment or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ðŸ“Š LOC Metrics')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
